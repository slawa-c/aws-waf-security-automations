# Copyright 2020 Amazon.com, Inc. or its affiliates. All Rights Reserved.
#
# Licensed under the Apache License, Version 2.0 (the "License").
# You may not use this file except in compliance with the License.
# A copy of the License is located at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# or in the "license" file accompanying this file. This file is distributed
# on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either
# express or implied. See the License for the specific language governing
# permissions and limitations under the License.

AWSTemplateFormatVersion: 2010-09-09
Description: >-
  (SO0006-WebACL) - AWS WAF Security Automations %VERSION%: This AWS CloudFormation template helps
  you provision the AWS WAF Security Automations stack without worrying about creating and
  configuring the underlying AWS infrastructure.

  **WARNING** This template creates an AWS WAF Web ACL and Amazon CloudWatch custom metrics.
  You will be billed for the AWS resources used if you create a stack from this template.

Parameters:
  ActivateAWSManagedRulesParam:
    Type: String
  ActivateSqlInjectionProtectionParam:
    Type: String
  ActivateCrossSiteScriptingProtectionParam:
    Type: String
  ActivateHttpFloodProtectionParam:
    Type: String
  ActivateScannersProbesProtectionParam:
    Type: String
  ActivateReputationListsProtectionParam:
    Type: String
  ActivateBadBotProtectionParam:
    Type: String
  RequestThreshold:
    Type: Number
  RegionScope:
    Type: String
  ParentStackName:
    Type: String
  GlueAccessLogsDatabase:
    Type: String
  GlueAppAccessLogsTable:
    Type: String
  GlueWafAccessLogsTable:
    Type: String
  LogLevel:
    Type: String

Conditions:
  AWSManagedRulesActivated: !Equals
    - !Ref ActivateAWSManagedRulesParam
    - 'yes'

  SqlInjectionProtectionActivated: !Equals
    - !Ref ActivateSqlInjectionProtectionParam
    - 'yes'

  CrossSiteScriptingProtectionActivated: !Equals
    - !Ref ActivateCrossSiteScriptingProtectionParam
    - 'yes'

  HttpFloodProtectionRateBasedRuleActivated: !Equals
    - !Ref ActivateHttpFloodProtectionParam
    - 'yes - AWS WAF rate based rule'

  HttpFloodLambdaLogParser: !Equals
    - !Ref ActivateHttpFloodProtectionParam
    - 'yes - AWS Lambda log parser'

  HttpFloodAthenaLogParser: !Equals
    - !Ref ActivateHttpFloodProtectionParam
    - 'yes - Amazon Athena log parser'

  HttpFloodProtectionLogParserActivated: !Or
    - Condition: HttpFloodLambdaLogParser
    - Condition: HttpFloodAthenaLogParser

  ScannersProbesLambdaLogParser: !Equals
    - !Ref ActivateScannersProbesProtectionParam
    - 'yes - AWS Lambda log parser'

  ScannersProbesAthenaLogParser: !Equals
    - !Ref ActivateScannersProbesProtectionParam
    - 'yes - Amazon Athena log parser'

  ScannersProbesProtectionActivated: !Or
    - Condition: ScannersProbesLambdaLogParser
    - Condition: ScannersProbesAthenaLogParser

  ReputationListsProtectionActivated: !Equals
    - !Ref ActivateReputationListsProtectionParam
    - 'yes'

  BadBotProtectionActivated: !Equals
    - !Ref ActivateBadBotProtectionParam
    - 'yes'

Mappings:
  SourceCode:
    General:
      TemplateBucket: '%TEMPLATE_OUTPUT_BUCKET%'
      SourceBucket: '%DIST_OUTPUT_BUCKET%'
      KeyPrefix: '%SOLUTION_NAME%/%VERSION%'

Resources:
# Timers
# There is a rate throttling issue when creating so many calls to create IPSet (1 TPS)
# By daisychaining these timers at N second intervals we can pace the calls to create new IPSets
# binding them with DependsOn to the right timer

  TimerWhiteV4:
    Type: 'Custom::Timer'
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerBlackV4:
    Type: 'Custom::Timer'
    DependsOn: TimerWhiteV4
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerHttpFloodV4:
    Type: 'Custom::Timer'
    DependsOn: TimerBlackV4
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerScannersV4:
    Type: 'Custom::Timer'
    DependsOn: TimerHttpFloodV4
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerReputationV4:
    DependsOn: TimerScannersV4
    Type: 'Custom::Timer'
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerBadBotV4:
    Type: 'Custom::Timer'
    DependsOn: TimerReputationV4
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerWhiteV6:
    Type: 'Custom::Timer'
    DependsOn: TimerBadBotV4
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerBlackV6:
    Type: 'Custom::Timer'
    DependsOn: TimerWhiteV6
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerHttpFloodV6:
    Type: 'Custom::Timer'
    DependsOn: TimerBlackV6
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerScannersV6:
    Type: 'Custom::Timer'
    DependsOn: TimerHttpFloodV6
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerReputationV6:
    DependsOn: TimerScannersV6
    Type: 'Custom::Timer'
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

  TimerBadBotV6:
    Type: 'Custom::Timer'
    DependsOn: TimerReputationV6
    Properties:
      ServiceToken: !GetAtt CustomTimer.Arn

# IPV4 IPSets
  WAFWhitelistSetV4:
    Type: 'AWS::WAFv2::IPSet'
    DependsOn: TimerWhiteV4
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: 'IPV4'
      Name: !Sub '${ParentStackName}WhitelistSetIPV4'
      Description: 'Allow List for IPV4 addresses'
      Addresses: []

  WAFBlacklistSetV4:
    Type: 'AWS::WAFv2::IPSet'
    DependsOn: TimerBlackV4
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: 'IPV4'
      Name: !Sub '${ParentStackName}BlacklistSetIPV4'
      Description: 'Block Denied List for IPV4 addresses'
      Addresses: []

  WAFHttpFloodSetV4:
    Type: 'AWS::WAFv2::IPSet'
    Condition: HttpFloodProtectionLogParserActivated
    DependsOn: TimerHttpFloodV4
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: 'IPV4'
      Name: !Sub '${ParentStackName}HTTPFloodSetIPV4'
      Description: 'Block HTTP Flood IPV4 addresses'
      Addresses: []

  WAFScannersProbesSetV4:
    Type: 'AWS::WAFv2::IPSet'
    Condition: ScannersProbesProtectionActivated
    DependsOn: TimerScannersV4
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: 'IPV4'
      Name: !Sub '${ParentStackName}ScannersProbesSetIPV4'
      Description: 'Block Scanners/Probes IPV4 addresses'
      Addresses: []

  WAFReputationListsSetV4:
    Type: 'AWS::WAFv2::IPSet'
    Condition: ReputationListsProtectionActivated
    DependsOn: TimerReputationV4
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: 'IPV4'
      Name: !Sub '${ParentStackName}IPReputationListsSetIPV4'
      Description: 'Block Reputation List IPV4 addresses'
      Addresses: []
 
  WAFBadBotSetV4:
    Type: 'AWS::WAFv2::IPSet'
    Condition: BadBotProtectionActivated
    DependsOn: TimerBadBotV4
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: 'IPV4'
      Name: !Sub '${ParentStackName}IPBadBotSetIPV4'
      Description: 'Block Bad Bot IPV4 addresses'
      Addresses: []

# IPV6 IPSets
# Introduced an artificial DependsOn property here on each of the previous IPSets to address
# a rate throttling issue when creating so many calls to create IPSet
# The rate limit is 1 call per second to the IPSet API
  WAFWhitelistSetV6:
    Type: 'AWS::WAFv2::IPSet'
    DependsOn: TimerWhiteV6
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: IPV6
      Name: !Sub '${ParentStackName}WhitelistSetIPV6'
      Description: 'Allow list for IPV6 addresses'
      Addresses: []

  WAFBlacklistSetV6:
    Type: 'AWS::WAFv2::IPSet'
    DependsOn: TimerBlackV6
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: IPV6
      Name: !Sub '${ParentStackName}BlacklistSetIPV6'
      Description: 'Block Denied List for IPV6 addresses'
      Addresses: []

  WAFHttpFloodSetV6:
    Type: 'AWS::WAFv2::IPSet'
    Condition: HttpFloodProtectionLogParserActivated
    DependsOn: TimerHttpFloodV6
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: IPV6
      Name: !Sub '${ParentStackName}HTTPFloodSetIPV6'
      Description: 'Block HTTP Flood IPV6 addresses'
      Addresses: []

  WAFScannersProbesSetV6:
    Type: 'AWS::WAFv2::IPSet'
    Condition: ScannersProbesProtectionActivated
    DependsOn: TimerScannersV6
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: IPV6
      Name: !Sub '${ParentStackName}ScannersProbesSetIPV6'
      Description: 'Block Scanners/Probes IPV6 addresses'
      Addresses: []

  WAFReputationListsSetV6:
    Type: 'AWS::WAFv2::IPSet'
    Condition: ReputationListsProtectionActivated
    DependsOn: TimerReputationV6
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: IPV6
      Name: !Sub '${ParentStackName}IPReputationListsSetIPV6'
      Description: 'Block Reputation List IPV6 addresses'
      Addresses: []

  WAFBadBotSetV6:
    Type: 'AWS::WAFv2::IPSet'
    Condition: BadBotProtectionActivated
    DependsOn: TimerBadBotV6
    Properties:
      Scope: !Sub '${RegionScope}'
      IPAddressVersion: IPV6
      Name: !Sub '${ParentStackName}IPBadBotSetIPV6'
      Description: 'Block Bad Bot IPV6 addresses'
      Addresses: []

  LambdaRoleCustomTimer:
    Type: 'AWS::IAM::Role'
    Properties:
      AssumeRolePolicyDocument:
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: CloudWatchLogs
          PolicyDocument:
            Statement:
              - Effect: Allow
                Action:
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogGroup'
                  - 'logs:CreateLogStream'
                  - 'logs:PutLogEvents'
                Resource:
                  - !Sub 'arn:${AWS::Partition}:logs:${AWS::Region}:${AWS::AccountId}:log-group:/aws/lambda/*CustomTimer*'

  CustomTimer:
    Type: 'AWS::Lambda::Function'
    Properties:
      Description: >-
        This lambda function counts X seconds and can be used to slow down component creation in CloudFormation
      Handler: 'timer.lambda_handler'
      Role: !GetAtt LambdaRoleCustomTimer.Arn
      Code:
        S3Bucket: !Join ['-', [!FindInMap ["SourceCode", "General", "SourceBucket"], !Ref 'AWS::Region']]
        S3Key: !Join ['/', [!FindInMap ["SourceCode", "General", "KeyPrefix"], 'timer.zip']]
      Runtime: python3.8
      MemorySize: 128
      Timeout: 300
      Environment:
        Variables:
          SECONDS: '2'
          LOG_LEVEL: !Ref LogLevel
    Metadata:
      cfn_nag:
        rules_to_suppress:
        - id: W89
          reason: There is no need to run this lambda in a VPC
        - id: W92
          reason: There is no need for Reserved Concurrency

# Adding a (priority 0) rule for AWS Managed RuleSet, optionally triggered by params

  WAFWebACL:
    Type: AWS::WAFv2::WebACL
    Properties:
      Name: !Ref 'ParentStackName'
      Description: 'Custom WAFWebACL'
      Scope: !Sub '${RegionScope}'
      VisibilityConfig: 
        SampledRequestsEnabled: true
        CloudWatchMetricsEnabled: true
        MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'WAFWebACL']]
      DefaultAction:
        Allow: {}
      CustomResponseBodies:
        429-bose-custom-response:
          ContentType: "TEXT_HTML"
          Content: "<!doctype html>\n<html>\n\n<head>\n\t<meta charset='UTF-8'>\n\t<meta name='viewport' content='width=device-width, initial-scale=1.0' />\n\t<title class=\"js-title\">HTTP/1.1 429 Too Many Requests</title>\n<style>\n\nbody {\n\tmargin: 0;\n\tpadding: 0;\n\tbackground: #eeeeee;\n\tfont-family: Bose Gothic, Helvetica, Sans-serif;\n}\n.bose-maintenanceNotice {\n\tmargin: auto;\n\twidth: 100%;\n\tmax-width: 1000px;\n\tbackground: #ffffff;\n}\n.bose-maintenanceNotice__header {\n\tbackground: #000000;\n\theight: 40px;\n\twidth: 100%;\n}\n.bose-maintenanceNotice__logo {\n\theight: 40px;\n}\n\n.-paddingTop {\n\tpadding-top: 5%;\n}\n.bose-maintenanceNotice__copy {\n\ttext-align: center;\n\tpadding-top: 10%;\n\tpadding-bottom: 10%;\n\tpadding-left: 10px;\n\tpadding-right: 10px;\n}\n.bose-maintenanceNotice__title {\n\tfont-size: 60px;\n\tcolor: #000000;\n\tmargin-bottom: 2px;\n\tfont-weight: normal;\n}\n\n.bose-maintenanceNotice__subtitle {\n\tfont-size: 30px;\n\tmargin-bottom: 12px;\n\tfont-weight: normal;\n}\n\n.bose-maintenanceNotice__text .bose-maintenanceNotice__text__phone {\n\tfont-size: 18px;\n\tcolor: #666666;\n}\n\n.bose-maintenanceNotice__footer {\n\ttext-align: right;\n\tbackground: #222222;\n\twidth: 100%;\n}\n\n.bose-maintenanceNotice__footer--right {\n\tmargin-right: 0px;\n\tdisplay: inline-block;\n\tpadding: 45px 30px 45px 30px;\n\tfont-size: 12px;\n\tcolor: #ccc;\n\ttext-align: right;\n\ttext-transform: uppercase;\n}\n</style>\n</head>\n<body>\n\t<div class='bose-maintenanceNotice'>\n\t\t<div class='bose-maintenanceNotice__header'>\n\t\t\t<img class='bose-maintenanceNotice__logo' src='data:image/gif;base64,R0lGODlhbwAeAPYAABQUFLi4uLW1tYGBgbe3t0lJSQgICEJCQrCwsC8vLxoaGo+Pj6WlpRgYGG1tbePj4zQ0NJeXlz8/P/X19QwMDOjo6LOzs/r6+mpqatfX1/n5+dnZ2T09PSEhIfb29sXFxZmZmU1NTURERPz8/GVlZc3NzSUlJVBQUOfn53Nzc319fSgoKODg4MLCwqysrNzc3AYGBr+/v87OzgMDAwUFBbu7u4uLi19fXxwcHAoKCkBAQFNTU8bGxp+fn3d3dwAAAMnJydDQ0EdHR97e3u7u7vLy8oWFhVpaWjg4OFZWVsvLy////+3t7WdnZ3t7ex8fH4iIiOTk5KOjo9ra2hAQEOvr65SUlIKCgvHx8WJiYhISEtPT06GhoXR0dMDAwH9/f2hoaCZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySZFySH5BAEAAGEALAAAAABvAB4AAAf/gD+Cg4SFhoeIiYqLjI2Oj5CRkpOUlZaXmJmam5ydnp+goaKjpKWmp6ipqqusra6viwACAbS1tgQFPzlfs7a2CAk/CgsEvrYMDT8Oxsy+AwcQrBFL1EsTU1MV1SNWPxYj1UtTF+FLGAYZ4Rob5UscTx7hDxvY9fb1ICEiqwng1SSCJFAbocFEiCX+luQiEA4FBRXhJqz4wSJcix8uwr2gAWtRjREgRygRRKMGwhFQZkxBSM3FDwjhRtxoUCTkiC+CcujUOUNHuRAdFe0ox4IHj4ojJvSg4YNl0ic/Ptjk8WNBuRJGs4L4MSPIthEfsmYVEvSHgSHyZMggcnJkAywg1REa+XEk4QgkP3YA2QtEiZIJ4Zj8IGFTZInDiAXMKOsknAeoP6D4A/KjBzhwDygYeGCTC9fFMxb/MOHBZgoKVcJ1K3tIAeBqAwQ9gQsSCYS44BxEZmmtQZaTIA/QEJBwwwyrA6tQ6bilufPnnG1uaA4YnGcXl8FVGXKZWoofGxIueYAi4QUhJjSEXELkeXMlAFR5mU+/vv36MWLUUMHxRo38+f33XwwCAPTDFzUkqKB+CbqQiw8KCggggF2wZuGFGGao4YYcdujhhyCGKOKIJJZoYkeBAAA7' alt='Bose' />\n\t\t</div>\n\n\t\t<div class='bose-maintenanceNotice__copy'>\n\t\t\t<h1 class='bose-maintenanceNotice__title js-maintenanceNotice__title'>HTTP/1.1 429</h1>\n\n\t\t\t<h3 class='bose-maintenanceNotice__subtitle js-maintenanceNotice__subtitle -paddingTop'>Too many requests.</h3>\n\t\t\t<p class='bose-maintenanceNotice__text'>\n\t\t\t\t<span class='js-maintenance-text-1'>Sorry for the inconvenience, but you are generating too many requests at this moment.</span>\n\t\t\t\t<br /><span class='js-maintenance-text-2'>Your IP address will be blocked for 240 min.</span>\n\t\t\t\t<br /><span class='js-maintenance-text-3'>Thanks for your patience, try again later</span>\n\t\t\t</p>\n\n\t\t\t<p class='bose-maintenanceNotice__text__phone -paddingTop js-maintenanceNotice__text__phone'>\n\t\t\t\tHave questions? Call us at 1-800-379-2073.\n\t\t\t</p>\n\t\t</div>\n\n\t\t<div class='bose-maintenanceNotice__footer'>\n\t\t\t<div class='bose-maintenanceNotice__footer--right js-maintenanceNotice__footer--right'>\n\t\t\t\tBose Corporation &copy;<span class=\"js-copyright-year\">2021</span>\n\t\t\t</div>\n\t\t</div>\n\t</div>\n\t\n\n</body>\n</html>"
      Rules:
        - !If
          - AWSManagedRulesActivated
          - Name: AWS-AWSManagedRulesCommonRuleSet
            Priority: 0
            OverrideAction:
              None: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: MetricForAMRCRS
            Statement:
              ManagedRuleGroupStatement:
                VendorName: AWS
                Name: AWSManagedRulesCommonRuleSet
          - !Ref 'AWS::NoValue'
        - Name: !Sub '${ParentStackName}WhitelistRule'
          Priority: 1
          Action:
            Allow: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'WhitelistRule']]
          Statement:
            OrStatement:
              Statements:
                - IPSetReferenceStatement:
                    Arn: !GetAtt WAFWhitelistSetV4.Arn
                - IPSetReferenceStatement:
                    Arn: !GetAtt WAFWhitelistSetV6.Arn
        - Name: !Sub '${ParentStackName}BlockRequestOver8k'
          Priority: 2
          Action:
            Count: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'BlockRequestOver8k']]
          Statement:
            SizeConstraintStatement:
              FieldToMatch:
                Body:
                  OversizeHandling: MATCH
              ComparisonOperator: GT
              Size: 8192
              TextTransformations:
                - Priority: 0
                  Type: NONE
        - Name: !Sub '${ParentStackName}AWSManagedRulesKnownBadInputsRuleSet'
          Priority: 3
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'AWSManagedRulesKnownBadInputsRuleSet']]
          Statement:
            ManagedRuleGroupStatement:
              VendorName: AWS
              Name: AWSManagedRulesKnownBadInputsRuleSet
          OverrideAction:
            None: {}
        - Name: !Sub '${ParentStackName}BlacklistRule'
          Priority: 4
          Action:
            Block: {}
          VisibilityConfig:
            SampledRequestsEnabled: true
            CloudWatchMetricsEnabled: true
            MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'BlacklistRule']]
          Statement:
            OrStatement:
              Statements:
                - IPSetReferenceStatement:
                    Arn: !GetAtt WAFBlacklistSetV4.Arn
                - IPSetReferenceStatement:
                    Arn: !GetAtt WAFBlacklistSetV6.Arn
        - !If
          - HttpFloodProtectionLogParserActivated
          - Name: !Sub '${ParentStackName}HttpFloodRegularRule'
            Priority: 5
            Action:
              Block:
                CustomResponse:
                  ResponseCode: 429
                  CustomResponseBodyKey: 429-bose-custom-response
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'HttpFloodRegularRule']]
            Statement:
              OrStatement:
                Statements:
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFHttpFloodSetV4.Arn
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFHttpFloodSetV6.Arn
          - !Ref 'AWS::NoValue'
        - !If
          - HttpFloodProtectionRateBasedRuleActivated
          - Name: !Sub '${ParentStackName}HttpFloodRateBasedRule'
            Priority: 6
            Action:
              Block: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'HttpFloodRateBasedRule']]
            Statement:
              RateBasedStatement:
                AggregateKeyType: "IP"
                Limit: !Ref RequestThreshold
          - !Ref 'AWS::NoValue'
        - !If
          - ScannersProbesProtectionActivated
          - Name: !Sub '${ParentStackName}ScannersAndProbesRule'
            Priority: 7
            Action:
              Block: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'ScannersProbesRule']]
            Statement:
              OrStatement:
                Statements:
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFScannersProbesSetV4.Arn
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFScannersProbesSetV6.Arn
          - !Ref 'AWS::NoValue'
        - !If
          - ReputationListsProtectionActivated
          - Name: !Sub '${ParentStackName}IPReputationListsRule'
            Priority: 8
            Action:
              Block: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'IPReputationListsRule']]
            Statement:
              OrStatement:
                Statements:
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFReputationListsSetV4.Arn
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFReputationListsSetV6.Arn
          - !Ref 'AWS::NoValue'
        - !If
          - BadBotProtectionActivated
          - Name: !Sub '${ParentStackName}BadBotRule'
            Priority: 9
            Action:
              Block: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'BadBotRule']]
            Statement:
              OrStatement:
                Statements:
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFBadBotSetV4.Arn
                  - IPSetReferenceStatement:
                      Arn: !GetAtt WAFBadBotSetV6.Arn
          - !Ref 'AWS::NoValue'
        - !If
          - SqlInjectionProtectionActivated
          - Name: !Sub '${ParentStackName}SqlInjectionRule'
            Priority: 20
            Action:
              Block: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'SqlInjectionRule']]
            Statement:
              OrStatement:
                Statements:
                  - SqliMatchStatement:
                      FieldToMatch:
                        QueryString: {}
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
                  - SqliMatchStatement:
                      FieldToMatch:
                        Body:
                          OversizeHandling: CONTINUE
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
                  - SqliMatchStatement:
                      FieldToMatch:
                        UriPath: {}
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
                  - SqliMatchStatement:
                      FieldToMatch:
                        SingleHeader: {Name: "Authorization"}
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
                  - SqliMatchStatement:
                      FieldToMatch:
                        SingleHeader: {Name: "Cookie"}
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
          - !Ref 'AWS::NoValue'
        - !If
          - CrossSiteScriptingProtectionActivated
          - Name: !Sub '${ParentStackName}XssRule'
            Priority: 30
            Action:
              Block: {}
            VisibilityConfig:
              SampledRequestsEnabled: true
              CloudWatchMetricsEnabled: true
              MetricName: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'XssRule']]
            Statement:
              OrStatement:
                Statements:
                  - XssMatchStatement:
                      FieldToMatch:
                        QueryString: {}
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
                  - XssMatchStatement:
                      FieldToMatch:
                        Body:
                          OversizeHandling: CONTINUE
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
                  - XssMatchStatement:
                      FieldToMatch:
                        UriPath: {}
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
                  - XssMatchStatement:
                      FieldToMatch:
                        SingleHeader: {Name: "Cookie"}
                      TextTransformations:
                        - Priority: 1
                          Type: URL_DECODE
                        - Priority: 2
                          Type: HTML_ENTITY_DECODE
          - !Ref 'AWS::NoValue'

Outputs:
# Arns
  WAFWhitelistSetV4Arn:
    Value: !GetAtt WAFWhitelistSetV4.Arn

  WAFBlacklistSetV4Arn:
    Value: !GetAtt WAFBlacklistSetV4.Arn

  WAFHttpFloodSetV4Arn:
    Value: !GetAtt WAFHttpFloodSetV4.Arn
    Condition: HttpFloodProtectionLogParserActivated

  WAFScannersProbesSetV4Arn:
    Value: !GetAtt WAFScannersProbesSetV4.Arn
    Condition: ScannersProbesProtectionActivated

  WAFReputationListsSetV4Arn:
    Value: !GetAtt WAFReputationListsSetV4.Arn
    Condition: ReputationListsProtectionActivated

  WAFBadBotSetV4Arn:
    Value: !GetAtt WAFBadBotSetV4.Arn
    Condition: BadBotProtectionActivated

  WAFWhitelistSetV6Arn:
    Value: !GetAtt WAFWhitelistSetV6.Arn

  WAFBlacklistSetV6Arn:
    Value: !GetAtt WAFBlacklistSetV6.Arn

  WAFHttpFloodSetV6Arn:
    Value: !GetAtt WAFHttpFloodSetV6.Arn
    Condition: HttpFloodProtectionLogParserActivated

  WAFScannersProbesSetV6Arn:
    Value: !GetAtt WAFScannersProbesSetV6.Arn
    Condition: ScannersProbesProtectionActivated

  WAFReputationListsSetV6Arn:
    Value: !GetAtt WAFReputationListsSetV6.Arn
    Condition: ReputationListsProtectionActivated

  WAFBadBotSetV6Arn:
    Value: !GetAtt WAFBadBotSetV6.Arn
    Condition: BadBotProtectionActivated

# Names
  NameWAFWhitelistSetV4:
    Value: !Sub '${ParentStackName}WhitelistSetIPV4'

  NameWAFBlacklistSetV4:
    Value: !Sub '${ParentStackName}BlacklistSetIPV4'

  NameHttpFloodSetV4:
    Value: !Sub '${ParentStackName}HTTPFloodSetIPV4'
    Condition: HttpFloodProtectionLogParserActivated

  NameScannersProbesSetV4:
    Value: !Sub '${ParentStackName}ScannersProbesSetIPV4'
    Condition: ScannersProbesProtectionActivated

  NameReputationListsSetV4:
    Value: !Sub '${ParentStackName}IPReputationListsSetIPV4'
    Condition: ReputationListsProtectionActivated

  NameBadBotSetV4:
    Value: !Sub '${ParentStackName}IPBadBotSetIPV4'
    Condition: BadBotProtectionActivated

  NameWAFWhitelistSetV6:
    Value: !Sub '${ParentStackName}WhitelistSetIPV6'

  NameWAFBlacklistSetV6:
    Value: !Sub '${ParentStackName}BlacklistSetIPV6'

  NameHttpFloodSetV6:
    Value: !Sub '${ParentStackName}HTTPFloodSetIPV6'
    Condition: HttpFloodProtectionLogParserActivated

  NameScannersProbesSetV6:
    Value: !Sub '${ParentStackName}ScannersProbesSetIPV6'
    Condition: ScannersProbesProtectionActivated

  NameReputationListsSetV6:
    Value: !Sub '${ParentStackName}IPReputationListsSetIPV6'
    Condition: ReputationListsProtectionActivated

  NameBadBotSetV6:
    Value: !Sub '${ParentStackName}IPBadBotSetIPV6'
    Condition: BadBotProtectionActivated

  GlueAccessLogsDatabase:
    Value: !Ref GlueAccessLogsDatabase

  GlueAppAccessLogsTable:
    Value: !Ref GlueAppAccessLogsTable

  GlueWafAccessLogsTable:
    Value: !Ref GlueWafAccessLogsTable

  WAFWebACL:
    Value: !Ref WAFWebACL

  WAFWebACLArn:
    Value: !GetAtt WAFWebACL.Arn

  WAFWebACLMetricName:
    Value: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'MaliciousRequesters']]

  IPReputationListsMetricName:
    Value: !Join ['', [!Join ['', !Split ['-', !Ref ParentStackName]], 'IPReputationListsRule']]

  Version:
    Value: "%VERSION%"

# Ids
  WAFWhitelistSetV4Id:
    Value: !GetAtt WAFWhitelistSetV4.Id

  WAFBlacklistSetV4Id:
    Value: !GetAtt WAFBlacklistSetV4.Id

  WAFHttpFloodSetV4Id:
    Value: !GetAtt WAFHttpFloodSetV4.Id
    Condition: HttpFloodProtectionLogParserActivated

  WAFScannersProbesSetV4Id:
    Value: !GetAtt WAFScannersProbesSetV4.Id
    Condition: ScannersProbesProtectionActivated

  WAFReputationListsSetV4Id:
    Value: !GetAtt WAFReputationListsSetV4.Id
    Condition: ReputationListsProtectionActivated

  WAFBadBotSetV4Id:
    Value: !GetAtt WAFBadBotSetV4.Id
    Condition: BadBotProtectionActivated

  WAFWhitelistSetV6Id:
    Value: !GetAtt WAFWhitelistSetV6.Id

  WAFBlacklistSetV6Id:
    Value: !GetAtt WAFBlacklistSetV6.Id

  WAFHttpFloodSetV6Id:
    Value: !GetAtt WAFHttpFloodSetV6.Id
    Condition: HttpFloodProtectionLogParserActivated

  WAFScannersProbesSetV6Id:
    Value: !GetAtt WAFScannersProbesSetV6.Id
    Condition: ScannersProbesProtectionActivated

  WAFReputationListsSetV6Id:
    Value: !GetAtt WAFReputationListsSetV6.Id
    Condition: ReputationListsProtectionActivated

  WAFBadBotSetV6Id:
    Value: !GetAtt WAFBadBotSetV6.Id
    Condition: BadBotProtectionActivated